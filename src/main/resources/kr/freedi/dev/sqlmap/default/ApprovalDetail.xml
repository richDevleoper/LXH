<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ApprovalDetail">

	<resultMap id="approveDetailMap" type="kr.freedi.dev.qapprove.domain.ApproveDetailVO">
		<result property="aprovalCode" column="APROVAL_CODE" />
		<result property="aprovalSeq" column="APROVAL_SEQ" />
		<result property="comNo" column="COM_NO" />
		<result property="comJobx" column="COM_JOBX" />
		<result property="comPosition" column="COM_POSITION" />
		<result property="comDepartCode" column="COM_DEPART_CODE" />
		<result property="aprovalRegDate" column="APROVAL_REG_DATE" />
		<result property="aprovalReqComNo" column="APROVAL_REQ_COM_NO" />
		<result property="aprovalCompltDate" column="APROVAL_COMPLT_DATE" />
		<result property="aprovalStatCode" column="APROVAL_STAT_CODE" />
		<result property="aprovalMailSendDate" column="APROVAL_MAIL_SEND_DATE" />
		<result property="aprovalMailSendYn" column="APROVAL_MAIL_SEND_YN" />
		<result property="aprovalComment" column="APROVAL_COMMENT" />
		
		<result property="userName" column="USER_NAME" />
		<result property="aprovalStat" column="APROVAL_STAT" />
		<result property="aprovalType" column="APROVAL_TYPE" />
	</resultMap>

		<sql id="defCond">
		
			<!-- <if test="searchRepName != null and searchRepName != ''">
				AND T.REP_NAME like '%' || #{searchRepName} || '%'
			</if>
			<if test="searchDivision != null and searchDivision != ''">
				AND T.REP_DEVISION_CODE = #{searchDivision}
			</if>
			<if test="searchType != null and searchType != ''">
				AND T.REP_TYPE_CODE = #{searchType}
			</if>
			<if test="searchStatus != null and searchStatus != ''">
				AND T.REP_STATUS_CODE = #{searchStatus}
			</if> -->
		
	</sql> 
	
		<insert id="insert">
		Insert into 
			TB_APPROVAL_DETAIL
			(
		        APROVAL_CODE
		        , APROVAL_SEQ
		        , COM_NO
		        , COM_JOBX
		        , COM_POSITION
		        , COM_DEPART_CODE
		        , APROVAL_REG_DATE
		        , APROVAL_REQ_COM_NO
		        , APROVAL_COMPLT_DATE
		        , APROVAL_STAT_CODE
		        , APROVAL_MAIL_SEND_DATE
		        , APROVAL_MAIL_SEND_YN
			) values (
		          #{aprovalCode}
		        , (select nvl(Max(APROVAL_SEQ), 0)+1 from TB_APPROVAL_DETAIL where APROVAL_CODE=#{aprovalCode} )
		        , #{comNo}
		        , #{comJobx}
		        , #{comPosition}
		        , #{comDepartCode}
		        , sysdate
		        , #{aprovalReqComNo}
		        , null
		        , #{aprovalStatCode}
		        , #{aprovalMailSendDate}
		        , #{aprovalMailSendYn}
			)
	</insert>
	
	
	
	
	<select id="selectNextFkey" resultType="string">
		SELECT GET_NEW_APROVAL_KEY() AS NEW_APROVAL_CODE FROM DUAL
	</select>
	

	
	<update id="updateStatus">
		UPDATE TB_APPROVAL_DETAIL
		SET
			aproval_stat_code = #{aprovalStatCode},
		    aproval_complt_date = sysdate,
		    aproval_comment = #{aprovalComment}
		WHERE
	        aproval_code = #{aprovalCode}
	    AND com_no = #{comNo}
	</update>
	
	<select id="selectList" resultMap="approveDetailMap">
		SELECT 
			T.APROVAL_CODE
			, T.APROVAL_SEQ
			, T.COM_NO
			, T.COM_JOBX
			, T.COM_POSITION
			, T.COM_DEPART_CODE
			, T.APROVAL_REG_DATE
			, T.APROVAL_REQ_COM_NO
			, T.APROVAL_COMPLT_DATE
			, T.APROVAL_STAT_CODE
            , get_code_nm('APR_STAT', T.APROVAL_STAT_CODE) APROVAL_STAT
            , get_code_nm('APR_TYPE', m.aproval_type)  aproval_type
			, T.APROVAL_MAIL_SEND_DATE
			, T.APROVAL_MAIL_SEND_YN
            , U.USER_NAME
            , T.APROVAL_COMMENT
		FROM TB_APPROVAL_DETAIL T
		     , tb_user_mst U
		     , tb_approval_mst m  
		WHERE T.COM_NO = U.COM_NO
		  AND T.APROVAL_CODE = m.APROVAL_CODE
		  AND T.APROVAL_CODE = #{aprovalCode}
		ORDER BY APROVAL_SEQ
	</select>
	
	<delete id="delete">
		DELETE FROM TB_APPROVAL_DETAIL 
		WHERE 
		<trim prefixOverrides="AND|OR">
		<if test="aprovalCode != null and aprovalCode != ''">
			AND APROVAL_CODE = #{aprovalCode}
		</if>
		</trim>
	</delete>
	
</mapper>

