<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ApproveDetail">

	<resultMap id="approveDetailMap" type="kr.freedi.dev.qapprove.domain.ApproveDetailVO">
		<!-- <result property="aprovalCode" column="APROVAL_CODE" />
		<result property="actRegNo" column="ACT_REG_NO" />
		<result property="actAprovalNo" column="ACT_APROVAL_NO" />
		<result property="aprovalType" column="APROVAL_TYPE" />
		<result property="aprovalState" column="APROVAL_STATE" />
		<result property="aprovalSubject" column="APROVAL_SUBJECT" />
		<result property="userId" column="USER_ID" />
		<result property="draftingDate" column="DRAFTING_DATE" />
		<result property="draftingComment" column="DRAFTING_COMMENT" />
		<result property="refBusCode" column="REF_BUS_CODE" />
		<result property="refBusType" column="REF_BUS_TYPE" />
		
		<result property="idx" column="IDX" />
		<result property="userName" column="USER_NAME" />
		<result property="aprovalTypeNm" column="APROVAL_TYPE_NM" />
		<result property="aprovalStateNm" column="APROVAL_STATE_NM" />
		<result property="refBusTypeNm" column="REF_BUS_TYPE_NM" />
		<result property="aprovalCompltDate" column="APROVAL_COMPLT_DATE" /> -->
	</resultMap>

<!--

 	<select id="selectListCount2" resultType="egovMap">
		SELECT
		    c.code_id repStatusCode, c.code_nm repStatus, nvl(m.cnt, 0) AS cnt
		FROM tb_code c,
		     (
		        SELECT
		            rep_status_code, rep_status, COUNT(1) cnt
		        FROM (
					<include refid="selectListBasic"></include>
					 ) a
		        GROUP BY rep_status_code, rep_status
		    ) m
		WHERE c.code_id = m.rep_status_code (+)
		  AND c.code_grp_id = 'REP_STAT'
		  AND c.act_flg = 'Y'
      ORDER BY c.code_id		 
	 </select>
	
	<select id="selectListCount" resultType="int">
		SELECT COUNT(*) FROM tb_report_mst T 
		<include refid="defCond"></include>
	</select> -->
	
		<sql id="defCond">
		
			<if test="searchRepName != null and searchRepName != ''">
				AND T.REP_NAME like '%' || #{searchRepName} || '%'
			</if>
			<if test="searchDivision != null and searchDivision != ''">
				AND T.REP_DEVISION_CODE = #{searchDivision}
			</if>
			<if test="searchType != null and searchType != ''">
				AND T.REP_TYPE_CODE = #{searchType}
			</if>
			<if test="searchStatus != null and searchStatus != ''">
				AND T.REP_STATUS_CODE = #{searchStatus}
			</if>
		
	</sql> 
	
	<sql id="selectListBasic">
	    WITH v_approval_mst AS (
            SELECT ROW_NUMBER() OVER( ORDER BY TO_NUMBER(aproval_code) ASC ) idx,
                ROW_NUMBER() OVER( ORDER BY TO_NUMBER(aproval_code) DESC ) rowidx,
                m.*
            FROM  tb_approval_mst m	    
	    )
	 	SELECT
	 	    T.idx,
		    T.aproval_code,
		    T.aproval_type,
		    get_code_nm('APR_TYPE', T.aproval_type)  aproval_type_nm,
		    T.aproval_state,
		    get_code_nm('APR_STAT', T.aproval_state) aproval_state_nm,
		    T.aproval_subject,
		    T.user_id,
		    u.user_name,
		    T.drafting_date,
		    T.drafting_comment,
		    (case when T.aproval_state='4' then (select max(aproval_complt_date) from tb_approval_detail where aproval_code=T.aproval_code ) else null end) as aproval_complt_date,
		    T.ref_bus_type,
            get_code_nm('BUS_TYPE', T.ref_bus_type) ref_bus_type_nm,
		    T.ref_bus_code
		FROM
		    v_approval_mst T,
		    tb_user_mst     u
		WHERE
		    T.user_id = u.com_no (+)
            <include refid="defCond"></include>
	</sql>
	
	<select id="selectList" resultMap="approveMap">
		<include refid="selectListBasic"></include>
		  and rowidx between (#{currentPageNo}*#{recordCountPerPage}+1-#{recordCountPerPage}) and (#{currentPageNo}*#{recordCountPerPage})
		  order by idx desc
	</select>
	
	
	<select id="selectNextFkey" resultType="string">
		SELECT GET_NEW_APROVAL_KEY() AS NEW_APROVAL_CODE FROM DUAL
	</select>
	
	<insert id="insert">
		Insert into 
			TB_APPROVAL_MST 
		(
			APROVAL_CODE
			, ACT_REG_NO
			, ACT_APROVAL_NO
			, APROVAL_TYPE
			, APROVAL_STATE
			, APROVAL_SUBJECT
			, USER_ID
			, DRAFTING_DATE
			, DRAFTING_COMMENT
		) values (
			#{aprovalCode}
			, #{actRegNo}
			, #{actAprovalNo}
			, #{aprovalType}
			, #{aprovalState}
			, #{aprovalSubject}
			, #{userId}
			, #{draftingDate}
			, #{draftingComment}
		);
	</insert>
	
	<update id="update">
	
		UPDATE TB_REPORT_MST SET 
			REP_NAME = #{repName} 
			, REP_DEVISION_CODE = #{repDivisionCode} 
			, REP_TYPE_CODE = #{repTypeCode} 
			, REP_SECTOR_CODE = #{repSectorCode} 
			, REP_PRODUCT_CLASS = #{repProductClass} 
			, REP_LEADER_BELT_CODE = #{repLeaderBeltCode} 
			, REP_ACTION_TYPE_CODE = #{repActionTypeCode} 
			, REP_MBB_USE_RATE_CODE = #{repMbbUseRateCode}
			, REP_USE_REF_DATE = #{repUseRefDate} 
			, REP_STATUS_CODE = #{repStatusCode} 
 
			, REP_KEYWORD = #{repKeyword} 
			, REP_UPDATE_USER = #{repRegUser} 
			, REP_UPDATE_DATE = sysdate
			, REP_APPROVAL_CODE = #{repApprovalCode} 
			, REP_USE_YN = #{repUseYn} 
			, REP_MAIL_SEND_YN = #{repMailSendYn} 
			, REP_MAIL_SEND_DATE = #{repMailSendDate} 
			, REP_PLACE_CODE = #{repPlaceCode} 
			, REP_LEADER_CODE = #{repLeaderCode} 
			, REP_FILE_YN = #{repFileYn} 
		WHERE
		REP_CODE = #{repCode}
	</update>
	
	<select id="select" resultMap="approveMap">
		SELECT 
			REP_CODE
			, REP_NAME
			, REP_MENU_CODE
			, REP_DEVISION_CODE
			, REP_TYPE_CODE
			, REP_SECTOR_CODE
			, REP_PRODUCT_CLASS
			, REP_LEADER_BELT_CODE
			, REP_ACTION_TYPE_CODE
			, REP_MBB_USE_RATE_CODE
			, REP_USE_REF_DATE
			, REP_STATUS_CODE
			, REP_KEYWORD
			, REP_REG_USER
			, REP_REG_DATE
			, REP_UPDATE_USER
			, REP_UPDATE_DATE
			, REP_APPROVAL_CODE
			, REP_USE_YN
			, REP_MAIL_SEND_YN
			, REP_MAIL_SEND_DATE
			, REP_PLACE_CODE
			, REP_LEADER_CODE
			, REP_FILE_YN
		FROM TB_REPORT_MST T  
		WHERE T.REP_CODE = #{repCode}
	</select>
	
</mapper>

